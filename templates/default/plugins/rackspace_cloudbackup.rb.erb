# Cookbook Name:: rackspace_cloudbackup
#
# Copyright 2014, Rackspace, US, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

provides 'rcbu'
provides 'rcbu/is_registered'
provides 'rcbu/agent_id'

require 'json'
    
def gather_data(bootstrap_file)
  begin
    bootstrap_raw_data = open(bootstrap_file).read
  rescue
    Ohai::Log.info("Error reading #{bootstrap_file}")
    return nil
  end
  
  begin
    bootstrap_data = JSON.parse(bootstrap_raw_data)
  rescue
    Ohai::Log.info("Error parsing #{bootstrap_file}")
    return nil
  end
  
  return bootstrap_data
end

rcbu Mash.new unless rackspace
rcbu[:is_registered] = nil unless rcbu[:is_registered]
rcbu[:agent_id]      = nil unless rcbu[:agent_id]

data = gather_data("<%= @bootstrap_file -%>")
unless data.nil?
  # WARNING: Don't return AccountId from this data!  It is not reliable and will result in race conditions!
  rcbu[:is_registered] = data['IsRegistered']
  rcbu[:agent_id]      = data['AgentId']
end
