depends 'rackspace'
provides 'rackspace/cloudbackup'
provides 'rackspace/cloudbackup/is_registered'
provides 'rackspace/cloudbackup/agent_id'

require 'json'
    
def gather_data(bootstrap_file)
  begin
    bootstrap_raw_data = open(bootstrap_file).read
  rescue
    Ohai::Log.info("Error reading #{bootstrap_file}")
    return nil
  end
  
  begin
    bootstrap_data = JSON.parse(bootstrap_raw_data)
  rescue
    Ohai::Log.info("Error parsing #{bootstrap_file}")
    return nil
  end
  
  return bootstrap_data
end

rackspace Mash.new unless rackspace
rackspace[:cloudbackup] = Mash.new unless rackspace[:cloudbackup]
rackspace[:cloudbackup][:is_registered] = nil unless rackspace[:cloudbackup][:is_registered]
rackspace[:cloudbackup][:agent_id]      = nil unless rackspace[:cloudbackup][:agent_id]

data = gather_data("<%= @bootstrap_file -%>")
unless data.nil?
  # WARNING: Don't return AccountId from this data!  It is not reliable and will result in race conditions!
  rackspace[:cloudbackup][:is_registered] = data['IsRegistered']
  rackspace[:cloudbackup][:agent_id]      = data['AgentId']
end
