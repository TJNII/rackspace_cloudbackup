#depends 'rackspace'
provides 'rcbu'
provides 'rcbu/is_registered'
provides 'rcbu/agent_id'

require 'json'
    
def gather_data(bootstrap_file)
  begin
    bootstrap_raw_data = open(bootstrap_file).read
  rescue
    Ohai::Log.info("Error reading #{bootstrap_file}")
    return nil
  end
  
  begin
    bootstrap_data = JSON.parse(bootstrap_raw_data)
  rescue
    Ohai::Log.info("Error parsing #{bootstrap_file}")
    return nil
  end
  
  return bootstrap_data
end

rcbu Mash.new unless rackspace
rcbu[:is_registered] = nil unless rcbu[:is_registered]
rcbu[:agent_id]      = nil unless rcbu[:agent_id]

data = gather_data("<%= @bootstrap_file -%>")
unless data.nil?
  # WARNING: Don't return AccountId from this data!  It is not reliable and will result in race conditions!
  rcbu[:is_registered] = data['IsRegistered']
  rcbu[:agent_id]      = data['AgentId']
end
